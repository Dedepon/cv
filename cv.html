<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<title>PIXI test</title>
	</head>
	<body>
		<script src="./pixi/pixi.min.js"></script>
		<script>

			//Aliases
			let application = PIXI.Application,
				Container = PIXI.Container,
				loader = PIXI.loader,
				resources = PIXI.loader.resources,
				TextureCache = PIXI.utils.TextureCache,
				Sprite = PIXI.Sprite,
				Rectangle = PIXI.Rectangle;

			//Create a Pixi pApplication
			let pApp = new application({ 
				width: 512, 
				height: 512,                       
				antialias: true, 
				transparent: false, 
				resolution: 1
			});

			//Add the canvas that Pixi automatically created for you to the HTML document
			document.body.appendChild(pApp.view);

			//load a JSON file and run the `setup` function when it's done
			loader
				.add("cat", "./images/cat.png")
				.load(setup);

			//Define variables that might be used in more 
			//than one function
			let catSprite, state;

			function setup() {

				//There are 3 ways to make sprites from textures atlas frames

				//1. Access the `TextureCache` directly
				let catTexture = TextureCache["cat"];
				catSprite = new Sprite(catTexture);

				catSprite.x = pApp.view.width / 2 - catSprite.width / 2;
				catSprite.y = pApp.view.height / 2 - catSprite.height / 2;
			
				catSprite.vx = 0;
				catSprite.vy = 0;

				pApp.stage.addChild(catSprite);

				//Capture the keyboard arrow keys
				let left = keyboard("ArrowLeft"),
					up = keyboard("ArrowUp"),
					right = keyboard("ArrowRight"),
					down = keyboard("ArrowDown");

				//Left arrow key `press` method
				left.press = () => {
					//Change the cat's velocity when the key is pressed
					catSprite.vx = -5;
					catSprite.vy = 0;
				};

				//Left arrow key `release` method
				left.release = () => {
					//If the left arrow has been released, and the right arrow isn't down,
					//and the cat isn't moving vertically:
					//Stop the cat
					if (!right.isDown && catSprite.vy === 0) {
						catSprite.vx = 0;
					}
				};

				//Up
				up.press = () => {
					catSprite.vy = -5;
					catSprite.vx = 0;
				};
				up.release = () => {
					if (!down.isDown && catSprite.vx === 0) {
						catSprite.vy = 0;
					}
				};

				//Right
				right.press = () => {
					catSprite.vx = 5;
					catSprite.vy = 0;
				};
				right.release = () => {
					if (!left.isDown && catSprite.vy === 0) {
						catSprite.vx = 0;
					}
				};

				//Down
				down.press = () => {
					catSprite.vy = 5;
					catSprite.vx = 0;
				};
				down.release = () => {
					if (!up.isDown && catSprite.vx === 0) {
						catSprite.vy = 0;
					}
				};


				//Set the game state
				state = play;
				
				//Start the game loop 
				pApp.ticker.add(delta => gameLoop(delta));
			}

			function gameLoop(delta) {
				//Update the current game state:
				state(delta);
			}
			
			//The `randomInt` helper function
			function randomInt(min, max) {
				return Math.floor(Math.random() * (max - min + 1)) + min;
			}

			function play(delta) {

				//Use the cat's velocity to make it move
				catSprite.x += catSprite.vx;
				catSprite.y += catSprite.vy
			}

			function keyboard(value) {
				let key = {};
				key.value = value;
				key.isDown = false;
				key.isUp = true;
				key.press = undefined;
				key.release = undefined;
				//The `downHandler`
				key.downHandler = event => {
					if (event.key === key.value) {
						if (key.isUp && key.press) key.press();
						key.isDown = true;
						key.isUp = false;
						event.preventDefault();
					}
				};

				//The `upHandler`
				key.upHandler = event => {
					if (event.key === key.value) {
						if (key.isDown && key.release) key.release();
						key.isDown = false;
						key.isUp = true;
						event.preventDefault();
					}
				};

				//Attach event listeners
				const downListener = key.downHandler.bind(key);
				const upListener = key.upHandler.bind(key);

				window.addEventListener(
					"keydown", downListener, false
				);
				window.addEventListener(
					"keyup", upListener, false
				);

				// Detach event listeners
				key.unsubscribe = () => {
					window.removeEventListener("keydown", downListener);
					window.removeEventListener("keyup", upListener);
				};

				return key;
			}

		</script>
	</body>
</html>