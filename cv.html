<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<title>PIXI test</title>
		<style>canvas { border: solid 1px black; }</style>
	</head>
	<body>
		<script src="./pixi/pixi.min.js"></script>
		<script>

			//Aliases
			let application = PIXI.Application,
				Container = PIXI.Container,
				loader = PIXI.loader,
				resources = PIXI.loader.resources,
				TextureCache = PIXI.utils.TextureCache,
				Sprite = PIXI.Sprite,
				Text = PIXI.Text,
				TextStyle = PIXI.TextStyle,
				Rectangle = PIXI.Rectangle;

			//Create a Pixi pApplication
			let pApp = new application({ 
				width: 512, 
				height: 512,                       
				antialias: true, 
				transparent: true, 
				resolution: 1
			});

			//Add the canvas that Pixi automatically created for you to the HTML document
			document.body.appendChild(pApp.view);

			//load a JSON file and run the `setup` function when it's done
			loader
				.add("cat", "./images/cat.png")
				.load(setup);

			//Define variables that might be used in more 
			//than one function
			let catSprite, state, title, style;

			function setup() {

				// add title
				style = new TextStyle({
					fontFamily: "Arial",
					fontSize: 36,
					fill: "white",
					stroke: '#0033ff',
					strokeThickness: 4,
					dropShadow: true,
					dropShadowColor: "#000000",
					dropShadowBlur: 4,
					dropShadowAngle: Math.PI / 6,
					dropShadowDistance: 6,
				});
				title = new Text("Welcome !!!", style);
				title.x = pApp.view.width / 2 - title.width / 2;
				title.y = 48;
				pApp.stage.addChild(title);

				let catTexture = TextureCache["cat"];
				catSprite = new Sprite(catTexture);

				catSprite.x = pApp.view.width / 2 - catSprite.width / 2;
				catSprite.y = pApp.view.height / 2 - catSprite.height / 2;
			
				catSprite.vx = 0;
				catSprite.vy = 0;

				pApp.stage.addChild(catSprite);

				//Capture the keyboard arrow keys
				let left = keyboard("ArrowLeft"),
					up = keyboard("ArrowUp"),
					right = keyboard("ArrowRight"),
					down = keyboard("ArrowDown");

				//Left
				left.press = () => {
					if (!right.isDown) {
						catSprite.vx = -5;
					} else {
						catSprite.vx = 0;						
					}
				};

				left.release = () => {
					if (!right.isDown) {
						catSprite.vx = 0;
					} else {
						catSprite.vx = 5;
					}
				};

				//Up
				up.press = () => {
					if (!down.isDown) {
						catSprite.vy = -5;
					} else {
						catSprite.vy = 0;
					}
				};
				up.release = () => {
					if (!down.isDown) {
						catSprite.vy = 0;
					} else {
						catSprite.vy = 5;
					}
				};

				//Right
				right.press = () => {
					if (!left.isDown) {
						catSprite.vx = 5;
					} else {
						catSprite.vx = 0;
					}
				};
				right.release = () => {
					if (!left.isDown) {
						catSprite.vx = 0;
					} else {
						catSprite.vx = -5;
					}
				};

				//Down
				down.press = () => {
					if (!up.isDown) {
						catSprite.vy = 5;
					} else {
						catSprite.vy = 0;
					}
				};
				down.release = () => {
					if (!up.isDown) {
						catSprite.vy = 0;
					} else {
						catSprite.vy = -5;
					}
				};


				//Set the game state
				state = play;
				
				//Start the game loop 
				pApp.ticker.add(delta => gameLoop(delta));
			}

			function gameLoop(delta) {
				//Update the current game state:
				state(delta);
			}
			
			//The `randomInt` helper function
			function randomInt(min, max) {
				return Math.floor(Math.random() * (max - min + 1)) + min;
			}

			function play(delta) {

				//Use the cat's velocity to make it move
				catSprite.x += catSprite.vx;
				catSprite.y += catSprite.vy
			}

			function keyboard(value) {
				let key = {};
				key.value = value;
				key.isDown = false;
				key.isUp = true;
				key.press = undefined;
				key.release = undefined;
				//The `downHandler`
				key.downHandler = event => {
					if (event.key === key.value) {
						if (key.isUp && key.press) key.press();
						key.isDown = true;
						key.isUp = false;
						event.preventDefault();
					}
				};

				//The `upHandler`
				key.upHandler = event => {
					if (event.key === key.value) {
						if (key.isDown && key.release) key.release();
						key.isDown = false;
						key.isUp = true;
						event.preventDefault();
					}
				};

				//Attach event listeners
				const downListener = key.downHandler.bind(key);
				const upListener = key.upHandler.bind(key);

				window.addEventListener(
					"keydown", downListener, false
				);
				window.addEventListener(
					"keyup", upListener, false
				);

				// Detach event listeners
				key.unsubscribe = () => {
					window.removeEventListener("keydown", downListener);
					window.removeEventListener("keyup", upListener);
				};

				return key;
			}

		</script>
	</body>
</html>